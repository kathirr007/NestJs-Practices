FROM node:22-alpine AS development

# 1. Install pnpm and Nest CLI
RUN npm i -g pnpm @nestjs/cli

WORKDIR /app

# 2. Configure pnpm to use a flat structure (helps with Docker volumes)
# and set the store directory explicitly
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

# Copy configuration files
COPY package.json pnpm-lock.yaml .npmrc ./

# 3. Install dependencies 
# --frozen-lockfile ensures consistency, --shamefully-hoist mimics npm structure
RUN pnpm install --shamefully-hoist --frozen-lockfile

COPY . .

# 4. Use the full path or pnpm exec to run the dev server
CMD ["pnpm", "run", "start:dev"]